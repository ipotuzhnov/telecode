#!/usr/bin/env node

'use strict'
const express   = require('express')
const app       = express()
const http      = require('http').Server(app)
const io        = require('socket.io')(http)
const path      = require('path')

const DIR = path.resolve(process.env.DIR || `/tmp/nodeist-colony-${Date.now()}`)

const sessions = {}
async function start () {
    console.log(`Initializing database in directory ${DIR}`)
    const connectedSockets = {}
    
    io.on('connection', async socket => {
        console.log(`${socket.id} connected`)
        connectedSockets[socket.id] = socket

        socket.on('room', name => {
            socket.on('reset', () => {
                sessions[name] = []
                io.to(name).emit('reset')
            })
            socket.join(name)
            if (!sessions[name]) {
                sessions[name] = []
            }
            socket.on('commit', data => {
                console.log('got commit', data)
                sessions[name].push(data)
                io.to(name).emit('change', data)
            })
            socket.on('replay', () => {
                socket.emit('replay', sessions[name])
            })
            socket.on('retrieve_file', data => {
                // data = { requestId, name }
                socket.broadcast.to(name).emit('retrieve_file', data)
                console.log(`Emitting file after retrieval request ${JSON.stringify(data)}`)
            })
            socket.on('file_retrieved', data => {
                // data = { requestId, name, content }
                socket.broadcast.to(name).emit('file_retrieved', data)
            })
            socket.on('file_changed', data => {
                console.log("file changed" + JSON.stringify(data));
                socket.broadcast.to(name).emit('file_changed', data);                
            })
            socket.emit('joined')
        })
    })
    
    app.use(express.static('public'))
    app.use('/node_modules', express.static('node_modules'))
    
    const PORT = process.env.PORT || 5000
    
    http.listen(PORT, () => console.log(`Listening on ${PORT}`))
}

start()
    .catch(e => {
        console.error(e)
    })
